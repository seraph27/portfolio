---
---

<style>
  /* Audio Player Styles */
  .audio-player {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.95);
    backdrop-filter: blur(20px);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    padding: 0.75rem 1rem;
    transform: translateY(100%);
    transition: transform 0.3s ease-in-out;
    z-index: 100;
  }

  .audio-player.active {
    transform: translateY(0);
  }

  .progress-bar {
    height: 4px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
    overflow: hidden;
    cursor: pointer;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #ec4899, #8b5cf6);
    transition: width 0.1s linear;
  }

  .volume-slider {
    width: 80px;
    height: 4px;
    -webkit-appearance: none;
    appearance: none;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
    outline: none;
    cursor: pointer;
  }

  .volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 12px;
    height: 12px;
    background: #ec4899;
    border-radius: 50%;
    cursor: pointer;
  }

  .volume-slider::-moz-range-thumb {
    width: 12px;
    height: 12px;
    background: #ec4899;
    border-radius: 50%;
    cursor: pointer;
    border: none;
  }
</style>

<!-- Audio Player -->
<div id="audio-player" class="audio-player">
  <div class="max-w-[1400px] mx-auto flex items-center gap-4">
    <button id="play-pause-btn" class="text-white hover:text-pink-400 transition-colors">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="play-icon"><polygon points="5 3 19 12 5 21 5 3"/></svg>
    </button>
    
    <div class="flex-1">
      <div class="flex items-center justify-between text-xs text-gray-400 mb-1">
        <span id="current-track-title" class="text-white text-sm font-medium">No track playing</span>
        <div class="flex items-center gap-2">
          <span id="current-time">0:00</span>
          <span>/</span>
          <span id="duration">0:00</span>
        </div>
      </div>
      <div class="progress-bar" id="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
    </div>

    <!-- Volume Control -->
    <div class="flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
      <input type="range" id="volume-slider" min="0" max="100" value="5" class="volume-slider" />
    </div>

    <button id="close-player-btn" class="text-gray-400 hover:text-white transition-colors">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
    </button>
  </div>
</div>

<script>
  class AudioPlayer {
    private audio: HTMLAudioElement
    private playerEl: HTMLElement | null
    private playPauseBtn: HTMLElement | null
    private playIcon: HTMLElement | null
    private progressBar: HTMLElement | null
    private progressFill: HTMLElement | null
    private currentTimeEl: HTMLElement | null
    private durationEl: HTMLElement | null
    private titleEl: HTMLElement | null
    private volumeSlider: HTMLInputElement | null
    private currentTrack: string | null = null

    constructor() {
      this.audio = new Audio()
      this.audio.volume = 0.05 // Set default volume to 5%
      this.playerEl = document.getElementById('audio-player')
      this.playPauseBtn = document.getElementById('play-pause-btn')
      this.playIcon = document.getElementById('play-icon')
      this.progressBar = document.getElementById('progress-bar')
      this.progressFill = document.getElementById('progress-fill')
      this.currentTimeEl = document.getElementById('current-time')
      this.durationEl = document.getElementById('duration')
      this.titleEl = document.getElementById('current-track-title')
      this.volumeSlider = document.getElementById('volume-slider') as HTMLInputElement

      this.init()
    }

    public init() {
      // Attach listeners directly to play buttons
      document.querySelectorAll('.play-button').forEach((btn) => {
        if (!(btn as HTMLElement).dataset.audioListener) {
          btn.addEventListener('click', this.handlePlayButtonClick.bind(this))
          ;(btn as HTMLElement).dataset.audioListener = 'true'
        }
      })

      // Only attach these once (they're on the persistent player)
      if (!this.playPauseBtn?.hasAttribute('data-audio-listener')) {
        this.playPauseBtn?.addEventListener('click', () => this.togglePlayPause())
        this.playPauseBtn?.setAttribute('data-audio-listener', 'true')
      }

      const closeBtn = document.getElementById('close-player-btn')
      if (closeBtn && !closeBtn.hasAttribute('data-audio-listener')) {
        closeBtn.addEventListener('click', () => this.close())
        closeBtn.setAttribute('data-audio-listener', 'true')
      }
      
      if (this.progressBar && !this.progressBar.hasAttribute('data-audio-listener')) {
        this.progressBar.addEventListener('click', (e) => {
          const rect = this.progressBar!.getBoundingClientRect()
          const percent = (e.clientX - rect.left) / rect.width
          this.audio.currentTime = percent * this.audio.duration
        })
        this.progressBar.setAttribute('data-audio-listener', 'true')
      }

      if (this.volumeSlider && !this.volumeSlider.hasAttribute('data-audio-listener')) {
        this.volumeSlider.addEventListener('input', (e) => {
          const volume = parseInt((e.target as HTMLInputElement).value) / 100
          this.audio.volume = volume
        })
        this.volumeSlider.setAttribute('data-audio-listener', 'true')
      }

      // Audio event listeners (only attach once)
      if (!this.audio.hasAttribute('data-audio-listener')) {
        this.audio.addEventListener('timeupdate', () => this.updateProgress())
        this.audio.addEventListener('loadedmetadata', () => {
          this.updateDuration()
        })
        this.audio.addEventListener('ended', () => this.onTrackEnd())
        this.audio.setAttribute('data-audio-listener', 'true')
      }
    }

    private handlePlayButtonClick = (e: Event) => {
      e.preventDefault()
      e.stopPropagation()
      const btn = e.currentTarget as HTMLElement
      const audioSrc = btn.dataset.audioSrc
      const entryTitle = btn.dataset.entryTitle || 'Unknown Track'
      const startTime = parseFloat(btn.dataset.audioStart || '0')
      const volume = parseFloat(btn.dataset.audioVolume || '5')
      if (audioSrc) {
        this.loadTrack(audioSrc, entryTitle, startTime, volume)
      }
    }

    private async loadTrack(src: string, title: string, startTime: number = 0, volume: number = 5) {
      if (!src) {
        console.error('No audio source provided')
        return
      }

      if (this.currentTrack === src && !this.audio.paused) {
        this.togglePlayPause()
        return
      }

      // Audio path is already resolved in the component (e.g., /blog/alpha/audio.mp3)
      // Encode the URL properly to handle spaces and special characters in filenames
      let audioUrl = src
      
      // If it's a relative path starting with /, encode only the filename part
      if (src.startsWith('/')) {
        const lastSlashIndex = src.lastIndexOf('/')
        if (lastSlashIndex !== -1) {
          const dirPath = src.substring(0, lastSlashIndex + 1)
          const filename = src.substring(lastSlashIndex + 1)
          audioUrl = dirPath + encodeURIComponent(filename)
        }
      } else if (!src.startsWith('http')) {
        // Fallback: try relative to current page
        const basePath = window.location.pathname.split('/').slice(0, -1).join('/') || '/'
        audioUrl = `${basePath}/${encodeURIComponent(src)}`
      }

      this.currentTrack = src
      this.audio.src = audioUrl
      
      // Set volume (convert from 0-100 to 0-1)
      const normalizedVolume = Math.max(0, Math.min(1, volume / 100))
      this.audio.volume = normalizedVolume
      
      // Update volume slider to match
      if (this.volumeSlider) {
        this.volumeSlider.value = volume.toString()
      }
      
      // Store start time for this track
      const trackStartTime = startTime
      
      // Add error handler
      this.audio.addEventListener('error', (e) => {
        console.error('Audio load error:', e)
        console.error('Audio URL attempted:', audioUrl)
        console.error('Audio element error:', this.audio.error)
      }, { once: true })
      
      // Set start time after metadata loads (one-time listener)
      this.audio.addEventListener('loadedmetadata', () => {
        if (trackStartTime > 0 && this.audio.duration && trackStartTime < this.audio.duration) {
          this.audio.currentTime = trackStartTime
        }
      }, { once: true })
      
      this.audio.load()
      
      try {
        await this.audio.play()
        if (this.titleEl) this.titleEl.textContent = title
        this.playerEl?.classList.add('active')
        this.updatePlayPauseIcon(true)
      } catch (error) {
        console.error('Error playing audio:', error)
        console.error('Audio URL attempted:', audioUrl)
        console.error('Audio element readyState:', this.audio.readyState)
        console.error('Audio element networkState:', this.audio.networkState)
      }
    }

    private async togglePlayPause() {
      if (this.audio.paused) {
        try {
          await this.audio.play()
          this.updatePlayPauseIcon(true)
        } catch (error) {
          console.error('Error playing audio:', error)
        }
      } else {
        this.audio.pause()
        this.updatePlayPauseIcon(false)
      }
    }

    private updatePlayPauseIcon(isPlaying: boolean) {
      if (this.playIcon) {
        this.playIcon.innerHTML = isPlaying 
          ? '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>'
          : '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>'
      }
    }

    private updateProgress() {
      const percent = (this.audio.currentTime / this.audio.duration) * 100
      if (this.progressFill) {
        this.progressFill.style.width = `${percent}%`
      }
      if (this.currentTimeEl) {
        this.currentTimeEl.textContent = this.formatTime(this.audio.currentTime)
      }
    }

    private updateDuration() {
      if (this.durationEl) {
        this.durationEl.textContent = this.formatTime(this.audio.duration)
      }
    }

    private formatTime(seconds: number): string {
      const mins = Math.floor(seconds / 60)
      const secs = Math.floor(seconds % 60)
      return `${mins}:${secs.toString().padStart(2, '0')}`
    }

    private onTrackEnd() {
      this.updatePlayPauseIcon(false)
    }

    private close() {
      this.audio.pause()
      this.playerEl?.classList.remove('active')
      this.currentTrack = null
    }
  }

  const audioPlayer = new AudioPlayer()

  // Re-attach listeners on Astro page navigation
  document.addEventListener('astro:page-load', () => {
    audioPlayer.init()
  })
</script>

