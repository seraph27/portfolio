---
import {
  getCombinedReadingTime,
  getSubpostCount,
  isSubpost,
} from '@/lib/data-utils'
import { formatDate } from '@/lib/utils'
import { Icon } from 'astro-icon/components'
import { Image } from 'astro:assets'
import type { CollectionEntry } from 'astro:content'

interface Props {
  entry: CollectionEntry<'blog'>
}

const { entry } = Astro.props
const formattedDate = formatDate(entry.data.date)
const readTime = await getCombinedReadingTime(entry.id)
const subpostCount = !isSubpost(entry.id) ? await getSubpostCount(entry.id) : 0
const difficulty = entry.data.difficulty || 5
const views = entry.data.views || Math.floor(Math.random() * 5000) + 500
const favorites = entry.data.favorites || Math.floor(Math.random() * 100) + 10

// Group difficulties by gamemode (default to osu if not specified)
const groupedDifficulties = new Map<string, Array<{ rating: number; mode: string }>>()
if (entry.data.difficulties && entry.data.difficulties.length > 0) {
  entry.data.difficulties.forEach((diff) => {
    const mode = diff.mode || 'osu'
    if (!groupedDifficulties.has(mode)) {
      groupedDifficulties.set(mode, [])
    }
    groupedDifficulties.get(mode)!.push({ rating: diff.rating, mode })
  })
} else {
  // Fallback: use difficulty field as single osu dot
  const osuRating = ((difficulty - 1) / 9) * 8.9 + 0.1
  groupedDifficulties.set('osu', [{ rating: osuRating, mode: 'osu' }])
}

// Convert hex to OKLCH (approximate conversions)
const hexToOklch = (hex: string): string => {
  const rgb = {
    r: parseInt(hex.slice(1, 3), 16) / 255,
    g: parseInt(hex.slice(3, 5), 16) / 255,
    b: parseInt(hex.slice(5, 7), 16) / 255,
  }
  
  // Simple RGB to OKLCH approximation
  // For exact conversion, we'd need a proper color library
  // Using approximate values based on the color
  const colorMap: Record<string, string> = {
    '#4290FB': 'oklch(0.7 0.15 250)', // light blue
    '#4FC0FF': 'oklch(0.75 0.12 220)', // cyan
    '#4FFFD5': 'oklch(0.85 0.1 180)', // turquoise
    '#7CFF4F': 'oklch(0.8 0.2 140)', // lime green
    '#F6F05C': 'oklch(0.9 0.15 100)', // yellow
    '#FF8068': 'oklch(0.75 0.15 40)', // orange
    '#FF4E6F': 'oklch(0.65 0.2 10)', // pink
    '#C645B8': 'oklch(0.6 0.2 320)', // purple
    '#6563DE': 'oklch(0.55 0.15 280)', // indigo
    '#18158E': 'oklch(0.3 0.15 270)', // dark blue
    '#000000': 'oklch(0.2 0 0)', // black
  }
  
  return colorMap[hex] || hex
}

// Get difficulty color based on osu's color spectrum (using OKLCH where possible)
const getDifficultyColor = (rating: number): string => {
  const domain = [0.1, 1.25, 2, 2.5, 3.3, 4.2, 4.9, 5.8, 6.7, 7.7, 9]
  // Using OKLCH colors
  const range = [
    'oklch(0.7 0.15 250)', // #4290FB light blue
    'oklch(0.75 0.12 220)', // #4FC0FF cyan
    'oklch(0.85 0.1 180)', // #4FFFD5 turquoise
    'oklch(0.8 0.2 140)', // #7CFF4F lime green
    'oklch(0.9 0.15 100)', // #F6F05C yellow
    'oklch(0.75 0.15 40)', // #FF8068 orange
    'oklch(0.65 0.2 10)', // #FF4E6F pink
    'oklch(0.6 0.2 320)', // #C645B8 purple
    'oklch(0.55 0.15 280)', // #6563DE indigo
    'oklch(0.3 0.15 270)', // #18158E dark blue
    'oklch(0.2 0 0)', // #000000 black
  ]
  
  // Clamp rating
  const clampedRating = Math.max(0.1, Math.min(9, rating))
  
  // Find the two colors to interpolate between
  let lowerIdx = 0
  let upperIdx = domain.length - 1
  
  for (let i = 0; i < domain.length - 1; i++) {
    if (clampedRating >= domain[i] && clampedRating <= domain[i + 1]) {
      lowerIdx = i
      upperIdx = i + 1
      break
    }
  }
  
  // Return the closest color (full interpolation would need proper color library)
  const lowerVal = domain[lowerIdx]
  const upperVal = domain[upperIdx]
  const t = (clampedRating - lowerVal) / (upperVal - lowerVal)
  return t < 0.5 ? range[lowerIdx] : range[upperIdx]
}

// Gamemode icon class mapping (FontAwesomeExtra)
const getGamemodeIconClass = (mode: string) => {
  const iconMap: Record<string, string> = {
    'osu': 'fa-extra-mode-osu',
    'taiko': 'fa-extra-mode-taiko',
    'catch': 'fa-extra-mode-fruits',
    'mania': 'fa-extra-mode-mania',
  }
  return iconMap[mode] || 'fa-extra-mode-osu'
}
---

<a 
  href={`/${entry.collection}/${entry.id}`}
  class="group relative block overflow-hidden w-full max-w-[495px] h-[140px] border border-[#1f1f26] bg-[#2a2d36] shadow-[0_12px_30px_rgba(0,0,0,0.35)] torus-font rounded-[10px]"
  data-entry-id={entry.id}
>
  <!-- Enlarged Background Image (dimmed, full width, visible through overlay) -->
  {
    entry.data.image ? (
      <div class="absolute inset-0">
        <Image
          src={entry.data.image}
          alt=""
          width={1000}
          height={270}
          class="h-full w-full object-cover opacity-30 blur-[2px] scale-[1.15]"
        />
      </div>
    ) : (
      <div class="absolute inset-0 bg-gradient-to-br from-purple-500/20 via-pink-500/20 to-orange-500/20" />
    )
  }

  <div class="relative h-full flex items-stretch">
    <!-- Left: Small visible image (180x135px like osu) -->
    <div class="relative w-[140px] h-[140px] flex-shrink-0 overflow-hidden">
      {
        entry.data.image ? (
          <Image
            src={entry.data.image}
            alt={entry.data.title}
            width={360}
            height={270}
            class="absolute inset-0 w-full h-full object-cover"
          />
        ) : (
          <div class="h-full w-full bg-gradient-to-br from-purple-500/50 via-pink-500/50 to-orange-500/50" />
        )
      }
    </div>

    <!-- Right: Text content over semi-transparent background -->
    <div class="flex flex-col justify-between h-[140px] w-full lg:w-[315px] relative z-10 card-right-bg pt-1 pr-[10px] pb-1.5 pl-[10px] rounded-l-[9px]">
      <!-- Title row with badge container (matches beatmapset-panel__info-row--title) -->
      <div class="flex items-center justify-between gap-2 mb-0.5">
        <h3 class="flex-1 min-w-0 truncate text-white text-[18px] font-semibold [text-shadow:0_1px_3px_rgba(0,0,0,0.75)]">
          {entry.data.title}
        </h3>
        <div class="flex items-center gap-1 flex-shrink-0 ml-auto">
          <!-- Badge container (matches beatmapset-panel__badge-container) -->
        </div>
      </div>

      <!-- Artist/Description row (matches beatmapset-panel__info-row--artist) -->
      <div class="flex items-center justify-between gap-2 mb-0.5">
        <p class="flex-1 min-w-0 truncate text-white text-sm font-semibold [text-shadow:0_1px_3px_rgba(0,0,0,0.75)]">
          {entry.data.description}
        </p>
        <div class="flex items-center gap-1 flex-shrink-0 ml-auto">
          <!-- Badge container -->
        </div>
      </div>

      <!-- Mapper row (matches beatmapset-panel__info-row--mapper) -->
      <div class="truncate mb-1 text-xs font-semibold text-[#E6E6E6]">
        mapped by <span class="text-[#E6E6E6]">{entry.id.split('/')[0] || 'author'}</span>
      </div>

      <!-- Stats row (matches beatmapset-panel__info-row--stats) -->
      <div class="flex items-center gap-2.5 mb-1">
        <div class="flex items-center gap-1 text-white text-xs font-normal" title={`${favorites.toLocaleString()} favourites`}>
          <span class="flex-shrink-0 flex items-center justify-center mr-1 text-[8px] text-[#E6E6E6]">
            <Icon name="lucide:heart" class="size-2" />
          </span>
          <span>{favorites.toLocaleString()}</span>
        </div>
        <div class="flex items-center gap-1 text-white text-xs font-normal" title={`${views.toLocaleString()} plays`}>
          <span class="flex-shrink-0 flex items-center justify-center mr-1 text-[8px] text-[#E6E6E6]">
            <Icon name="lucide:play-circle" class="size-2" />
          </span>
          <span>{views.toLocaleString()}</span>
        </div>
        <div class="flex items-center gap-1 text-white text-xs font-normal">
          <span class="flex-shrink-0 flex items-center justify-center mr-1 text-[8px] text-[#E6E6E6]">
            <Icon name="lucide:calendar" class="size-2" />
          </span>
          <span>{formattedDate}</span>
        </div>
      </div>

      <!-- Extra row: Status badge + Difficulty dots (matches beatmapset-panel__info-row--extra) -->
      <div class="flex items-center gap-2 mt-auto">
        <div class="flex items-center">
          <span class="px-[5px] py-0 rounded-full bg-[#3bd671] text-white uppercase text-xs font-extrabold leading-[14px]">
            Ranked
          </span>
        </div>
        <!-- Difficulty dots containers (one per gamemode, matches beatmapset-panel__extra-item--dots) -->
        {[...groupedDifficulties].map(([mode, difficulties]) => (
          <div class="flex items-center relative mx-[3px]">
            <!-- Gamemode icon (matches beatmapset-panel__beatmap-icon) -->
            <div class="flex mr-0.5 text-sm" title={`${mode} mode`}>
              <i class={getGamemodeIconClass(mode)}></i>
            </div>
            <!-- Difficulty dots for this gamemode -->
            <div class="flex items-center cursor-help relative">
              {difficulties.map((diff) => (
                <div 
                  class="rounded-full flex-shrink-0 w-[6px] h-3 mr-[1px]" 
                  style={`background-color: ${getDifficultyColor(diff.rating)};`}
                />
              ))}
              
              <!-- Tooltip on hover over difficulty dots -->
              {entry.data.tags && entry.data.tags.length > 0 && (
                <div class="difficulty-tooltip absolute bottom-full left-0 mb-2 opacity-0 pointer-events-none transition-opacity duration-150 z-20">
                  <div class="bg-popover border border-border rounded-md shadow-lg px-2 py-1.5 whitespace-nowrap">
                    <div class="flex gap-1.5">
                      {entry.data.tags.map((tag) => (
                        <span class="text-[10px] text-foreground">{tag}</span>
                      ))}
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        ))}
      </div>
    </div>
  </div>

  <!-- Play Button (centered on left image, appears on hover) -->
  <button
    class="play-button absolute left-[70px] top-1/2 -translate-x-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-white opacity-0 group-hover:opacity-95 transition-opacity duration-150 ease-in-out z-20 shadow-lg flex items-center justify-center"
    data-audio-src={entry.data.audio}
    aria-label="Play preview"
    onclick="event.preventDefault(); event.stopPropagation();"
  >
    <Icon name="lucide:play" class="size-5 ml-0.5 text-gray-900" />
  </button>
</a>

<style>
  /* Tooltip hover */
  .cursor-help:hover .difficulty-tooltip {
    opacity: 1;
  }
  
  /* Apply Torus font to all text in blog cards (osu-style) */
  .torus-font,
  .torus-font * {
    font-family: 'Torus', ui-sans-serif, system-ui, sans-serif;
  }
  
  /* Right side background gradient (default) */
  .card-right-bg {
    background: linear-gradient(0.25turn, rgba(42, 45, 54, 0.6), rgba(42, 45, 54, 1));
  }
  
  /* Right side background gradient (hover) */
  .group:hover .card-right-bg {
    background: linear-gradient(0.25turn, rgba(53, 57, 68, 0.6), rgba(53, 57, 68, 1));
  }
  
  /* Mobile: solid background */
  @media (max-width: 1024px) {
    .card-right-bg {
      background-color: rgba(45, 49, 60, 1);
    }
    
    .group:hover .card-right-bg {
      background-color: rgba(45, 49, 60, 1);
    }
  }
</style>

